document.addEventListener('DOMContentLoaded', () => {
    // Referências aos elementos HTML
    const authContainer = document.getElementById('auth-container');
    const loginForm = document.getElementById('login-form');
    const loginUsernameInput = document.getElementById('login-username');
    const loginPasswordInput = document.getElementById('login-password');
    const registerForm = document.getElementById('register-form');
    const showRegisterLink = document.getElementById('show-register');
    const showLoginLink = document.getElementById('show-login');
    const todoContainer = document.getElementById('todo-container');
    const taskForm = document.getElementById('task-form');
    const taskInput = document.getElementById('task-input');
    const taskList = document.getElementById('task-list');
    const taskCategoryInput = document.getElementById('task-category');
    const filterCategorySelect = document.getElementById('filter-category');
    const logoutBtn = document.getElementById('logout-btn');

    // Novos campos de data e status para o formulário de adição
    const taskStartDateInput = document.getElementById('task-start-date');
    const taskDueDateInput = document.getElementById('task-due-date');

    // Referências ao novo modal de edição
    const editModal = document.getElementById('edit-modal');
    const closeBtn = document.querySelector('.close-btn');
    const editForm = document.getElementById('edit-form');
    const editTaskIdInput = document.getElementById('edit-task-id');
    const editText = document.getElementById('edit-text');
    const editCategory = document.getElementById('edit-category');
    const editStartDate = document.getElementById('edit-start-date'); 
    const editDueDate = document.getElementById('edit-due-date');
    const editStatus = document.getElementById('edit-status'); 

    // URLs da API
    const API_URL = 'https://todo-list-backend-5qku.onrender.com';
    let token = localStorage.getItem('token');
    let userId = localStorage.getItem('userId');

    // Funções para alternar as telas
    function showLogin() {
        document.getElementById('register-form').style.display = 'none';
        document.getElementById('show-register').style.display = 'block';
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('show-login').style.display = 'none';
    }

    function showRegister() {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('show-register').style.display = 'none';
        document.getElementById('register-form').style.display = 'block';
        document.getElementById('show-login').style.display = 'block';
    }

    // Função para verificar o status de login
    function checkAuth() {
        if (token && userId) {
            authContainer.style.display = 'none';
            todoContainer.style.display = 'block';
            renderTasks();
        } else {
            authContainer.style.display = 'block';
            todoContainer.style.display = 'none';
            showLogin();
        }
    }

    // Função de login
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = loginUsernameInput.value;
        const password = loginPasswordInput.value;
        try {
            const response = await fetch(`${API_URL}/api/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();
            if (response.ok) {
                token = data.token;
                userId = data.userId;
                localStorage.setItem('token', token);
                localStorage.setItem('userId', userId);
                checkAuth();
            } else {
                alert(data.message || 'Erro no login.');
            }
        } catch (error) {
            alert('Erro de rede. Verifique a conexão com o servidor.');
        }
    });

    // Função de cadastro
    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('register-username').value;
        const password = document.getElementById('register-password').value;
        try {
            const response = await fetch(`${API_URL}/api/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            if (response.ok) {
                alert('Usuário cadastrado com sucesso! Faça login para continuar.');
                showLogin();
            } else {
                const data = await response.text();
                alert(data || 'Erro no cadastro.');
            }
        } catch (error) {
            alert('Erro de rede. Verifique a conexão com o servidor.');
        }
    });

    // --- Funções de Tarefas com autenticação ---

    // Rota GET: Buscar tarefas do usuário
    async function renderTasks(category = null) {
        taskList.innerHTML = '';
        let url = `${API_URL}/api/tarefas`;
        if (category && category !== 'all') {
            url += `?category=${encodeURIComponent(category)}`;
        }

        try {
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const tasks = await response.json();
            if (response.ok) {
                tasks.forEach(task => {
                    const li = document.createElement('li');
                    
                    const startDate = task.startDate ? new Date(task.startDate).toLocaleDateString('pt-BR') : 'N/A';
                    const dueDate = task.dueDate ? new Date(task.dueDate).toLocaleDateString('pt-BR') : 'N/A';
                    
                    let statusClass = '';
                    let statusText = '';
                    switch (task.status) {
                        case 'in-progress':
                            statusClass = 'tag-in-progress';
                            statusText = 'Em Progresso';
                            break;
                        case 'completed':
                            statusClass = 'tag-completed';
                            statusText = 'Concluída';
                            break;
                        default:
                            statusClass = 'tag-to-do';
                            statusText = 'A Fazer';
                            break;
                    }

                    li.innerHTML = `
                        <input type="checkbox" ${task.completed ? 'checked' : ''} data-id="${task._id}">
                        <div class="task-info">
                            <span>
                                ${task.text}
                                <span class="task-status-tag ${statusClass}">${statusText}</span>
                            </span>
                            <small class="task-details">
                                Categoria: ${task.category || 'Geral'} | Início: ${startDate} | Fim: ${dueDate}
                            </small>
                        </div>
                        <button class="edit-btn" data-id="${task._id}" data-text="${task.text}" data-category="${task.category}" data-start-date="${task.startDate}" data-due-date="${task.dueDate}" data-status="${task.status}">Editar</button>
                        <button class="delete-btn" data-id="${task._id}">Remover</button>
                    `;
                    if (task.completed) {
                        li.classList.add('completed');
                    }
                    taskList.appendChild(li);
                });

                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const taskId = e.target.dataset.id;
                        const taskText = e.target.dataset.text;
                        const taskCategory = e.target.dataset.category;
                        const taskStartDate = e.target.dataset.startDate;
                        const taskDueDate = e.target.dataset.dueDate;
                        const taskStatus = e.target.dataset.status;
                        openEditModal(taskId, taskText, taskCategory, taskStartDate, taskDueDate, taskStatus);
                    });
                });
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        deleteTask(e.target.dataset.id);
                    });
                });
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        toggleTaskCompleted(e.target.dataset.id, e.target.checked);
                    });
                });

            } else {
                alert('Não foi possível carregar as tarefas. Verifique se o servidor está rodando.');
            }
        } catch (error) {
            alert('Não foi possível carregar as tarefas. Verifique se o servidor está rodando.');
        }
    }

    // Rota POST: Adicionar nova tarefa para o usuário
    async function addTask(text, category, startDate, dueDate) {
        try {
            await fetch(`${API_URL}/api/tarefas`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ text, category, startDate, dueDate, status: 'to-do' }) 
            });
            renderTasks();
            taskInput.value = '';
            taskCategoryInput.value = '';
            taskStartDateInput.value = '';
            taskDueDateInput.value = '';
        } catch (error) {
            alert('Não foi possível adicionar a tarefa.');
        }
    }

    // Rota DELETE: Deletar tarefa do usuário
    async function deleteTask(id) {
        if (!confirm('Tem certeza de que deseja remover esta tarefa?')) {
            return;
        }
        try {
            await fetch(`${API_URL}/api/tarefas/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            renderTasks();
        } catch (error) {
            alert('Não foi possível remover a tarefa.');
        }
    }

    // Rota PUT: Atualizar o status de uma tarefa do usuário
    async function toggleTaskCompleted(id, completed) {
        try {
            const status = completed ? 'completed' : 'to-do';
            await fetch(`${API_URL}/api/tarefas/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ completed, status }) 
            });
            renderTasks();
        } catch (error) {
            alert('Não foi possível atualizar a tarefa.');
        }
    }

    // Lógica para abrir e fechar o modal
    function openEditModal(id, text, category, startDate, dueDate, status) {
        editTaskIdInput.value = id;
        editText.value = text;
        editCategory.value = category;
        editStartDate.value = startDate ? startDate.split('T')[0] : '';
        editDueDate.value = dueDate ? dueDate.split('T')[0] : '';
        editStatus.value = status;
        editModal.style.display = 'flex';
    }

    closeBtn.addEventListener('click', () => {
        editModal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
        if (event.target === editModal) {
            editModal.style.display = 'none';
        }
    });

    // Rota PUT: Salvar as edições do modal
    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const taskId = editTaskIdInput.value;
        const newText = editText.value.trim();
        const newCategory = editCategory.value.trim();
        const newStartDate = editStartDate.value;
        const newDueDate = editDueDate.value;
        const newStatus = editStatus.value;

        if (newText === '') {
            alert('O texto da tarefa não pode estar vazio.');
            return;
        }

        try {
            await fetch(`${API_URL}/api/tarefas/${taskId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ text: newText, category: newCategory, startDate: newStartDate, dueDate: newDueDate, status: newStatus }) 
            });
            editModal.style.display = 'none';
            renderTasks();
        } catch (error) {
            alert('Não foi possível editar a tarefa.');
        }
    });

    // Eventos para alternar a exibição
    showRegisterLink.addEventListener('click', (e) => {
        e.preventDefault();
        showRegister();
    });

    showLoginLink.addEventListener('click', (e) => {
        e.preventDefault();
        showLogin();
    });

    // Adiciona o listener do formulário de tarefas
    taskForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const taskText = taskInput.value.trim();
        const taskCategory = taskCategoryInput.value.trim() || 'Geral';
        const taskStartDate = taskStartDateInput.value.trim();
        const taskDueDate = taskDueDateInput.value.trim();
        if (taskText) {
            addTask(taskText, taskCategory, taskStartDate, taskDueDate);
        }
    });

    // Adiciona o listener para o filtro de categorias
    filterCategorySelect.addEventListener('change', (e) => {
        renderTasks(e.target.value);
    });

    // Listener para o botão de sair
    logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('userId');
        token = null;
        userId = null;
        checkAuth();
    });

    // Inicia a verificação de autenticação ao carregar a página
    checkAuth();
});
